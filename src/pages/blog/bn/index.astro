---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../../layouts/BaseLayout.astro';
import BookCard from '../../../components/BookCard.astro';

type BlogEntry = CollectionEntry<'blog'>;

const CURRENT_LANG = 'bn';

const today = new Date();
today.setHours(23, 59, 59, 999);

// 1. Fetch only English posts
const rawPosts = await getCollection('blog', ({ data }) => data.lang === CURRENT_LANG && data.pubDate <= today);

// 2. Sort AND Clean the slugs immediately
// This ensures that when PostCard reads 'post.slug', it sees "my-post" instead of "bn/my-post"
const allEnglishPosts = rawPosts
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
  .map((post) => ({
      ...post,
      slug: post.slug.replace(/^bn\//, '') // üí• THE FIX: Strip the "bn/" prefix
  }));

// Group by subject
const groupPostsBySubject = (posts: BlogEntry[]) => {
  const grouped = posts.reduce((acc, post) => {
    const subject = post.data.subject ?? "‡¶Ö‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶¨‡¶¶‡ßç‡¶ß";
    (acc[subject] ??= []).push(post);
    return acc;
  }, {} as Record<string, BlogEntry[]>);

  const subjectsArray = Object.entries(grouped);

  subjectsArray.forEach(([_, posts]) =>
    posts.sort((a, b) => a.data.chapter - b.data.chapter)
  );

  subjectsArray.sort(([a], [b]) =>
    a.localeCompare(b, undefined, { numeric: true })
  );

  return subjectsArray;
};

const subjectsWithPosts = groupPostsBySubject(allEnglishPosts);
---

<Layout title="English Episodes | Novi & Kernel" description="All English Episodes | Novi & Kernel Series" lang={CURRENT_LANG}>
  <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8 bg-neutral-light">
    <header class="text-center mb-12">
      <div class="flex justify-center space-x-4 dark-layer">
        <a href="/blog/en/" class="px-6 py-2 text-sm font-heading font-bold bg-accent-secondary rounded-full hover:bg-opacity-90 transition-all">
          English (EN)
        </a>
        <a href="/blog/bn/" class="px-6 py-2 text-sm font-heading font-bold bg-accent-primary rounded-full shadow-lg hover:opacity-90 transition-opacity">
          ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (BN)
        </a>
      </div>
    </header>

    {allEnglishPosts.length === 0 ? (
       <div class="text-center py-20 bg-neutral-light rounded-2xl border-2 border-dashed border-support-muted/30">
          <p class="text-xl font-heading font-bold text-support-muted">‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶™‡¶∞‡ßç‡¶¨ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
          <p class="text-accent-secondary mt-2">‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶´‡¶ø‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®, ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡¶æ‡¶ó‡¶æ‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®!</p>
       </div>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-20 gap-x-8 justify-items-center">
        {subjectsWithPosts.map(([subjectTitle, posts]) => (
          <BookCard subjectTitle={subjectTitle} posts={posts} lang={CURRENT_LANG}/>
        ))}
      </div>
    )}
  </main>
</Layout>
